name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # ìì‹ ì˜ ë ˆí¬ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì¡°ê±´ ì¶”ê°€
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  review:
    # ìì‹ ì˜ ë ˆí¬ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì¡°ê±´ ì¶”ê°€
    if: github.repository == 'mse0k/escargot' || github.repository == 'mse0k/escargot-review-bot'
    runs-on: self-hosted  # Self-hosted runner ì‚¬ìš© ì‹œ
    # runs-on: ubuntu-latest  # GitHub-hosted runner ì‚¬ìš© ì‹œ (ì„œë²„ê°€ ì™¸ë¶€ì— ìˆëŠ” ê²½ìš°)
    
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Compute diff range
        id: diff_range
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.payload;
            let baseSha, headSha;
            
            if (context.eventName === 'pull_request') {
              if (event.action === 'opened' || event.action === 'reopened') {
                // Full review: review entire PR
                baseSha = event.pull_request.base.sha;
                headSha = event.pull_request.head.sha;
              } else if (event.action === 'synchronize') {
                // Incremental review: only review the new push
                baseSha = event.before;
                headSha = event.pull_request.head.sha;
              }
            }
            
            core.setOutput('base_sha', baseSha);
            core.setOutput('head_sha', headSha);
            core.setOutput('pr_number', event.pull_request.number);
            
            console.log(`Review range: ${baseSha}..${headSha} (PR #${event.pull_request.number})`);
      
      - name: Call review API
        id: review
        env:
          REVIEW_SERVER_URL: ${{ secrets.REVIEW_SERVER_URL || 'http://localhost:8001' }}
        run: |
          echo "Calling review API at $REVIEW_SERVER_URL/review"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$REVIEW_SERVER_URL/review" \
            -H "Content-Type: application/json" \
            -d "{
              \"base_sha\": \"${{ steps.diff_range.outputs.base_sha }}\",
              \"head_sha\": \"${{ steps.diff_range.outputs.head_sha }}\",
              \"pull_request_number\": ${{ steps.diff_range.outputs.pr_number }}
            }")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $http_code)"
            echo "$body"
            exit 1
          fi
          
          echo "$body" > review.json
          comments_count=$(echo "$body" | jq '.comments | length')
          echo "comments_count=$comments_count" >> $GITHUB_OUTPUT
          
          if [ "$comments_count" -eq 0 ]; then
            echo "âœ… ë¦¬ë·° ì™„ë£Œ: ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "âœ… ë¦¬ë·° ì™„ë£Œ: $comments_countê°œì˜ ëŒ“ê¸€ ìƒì„±ë¨"
          fi
      
      - name: Post review comments
        if: steps.review.outputs.comments_count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewData = JSON.parse(fs.readFileSync('review.json', 'utf8'));
            const comments = reviewData.comments || [];
            
            console.log(`Posting ${comments.length} review comments...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const comment of comments) {
              try {
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: comment.commit_id,
                  path: comment.path,
                  line: comment.line,
                  side: comment.side,
                  body: comment.body
                });
                
                successCount++;
                console.log(`âœ… Posted comment on ${comment.path}:${comment.line}`);
                
                // Rate limit ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´ (200ms)
                await new Promise(resolve => setTimeout(resolve, 200));
              } catch (error) {
                errorCount++;
                console.error(`âŒ Failed to post comment on ${comment.path}:${comment.line}`, error.message);
              }
            }
            
            console.log(`\nğŸ“Š ê²°ê³¼: ${successCount}ê°œ ì„±ê³µ, ${errorCount}ê°œ ì‹¤íŒ¨`);

